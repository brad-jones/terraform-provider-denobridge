# yaml-language-server: $schema=https://taskfile.dev/schema.json
# https://taskfile.dev
version: 3

dotenv: [".env"]
set: [pipefail]
shopt: [globstar]

env:
  CGO_ENABLED: 0
  GOBIN: "{{.ROOT_DIR}}/.pixi/envs/default/bin"

tasks:
  init:
    desc: Setup dev env (anything that pixi can't install and setup for us).
    cmds:
      - lefthook install -f
      - git config pull.rebase true
      - git config core.editor "code --wait"
      - git config commit.template "$PWD/.gitmsgtpl"
      - deno install {{if .CI}}--frozen{{end}}
      - "{{if .CI}}git config --global user.name github-actions[bot]{{end}}"
      - "{{if .CI}}git config --global user.email github-actions[bot]@users.noreply.github.com{{end}}"

  install-go-tools:
    desc: Installs all the golang dev tooling that vscode needs (for some reason the auto install that VsCode tries to run fails)
    cmds:
      - if: "! which gotests"
        cmd: go install -v github.com/cweill/gotests/gotests@v1.6.0
      - if: "! which impl"
        cmd: go install -v github.com/josharian/impl@v1.4.0
      - if: "! which goplay"
        cmd: go install -v github.com/haya14busa/goplay/cmd/goplay@v1.0.0
      - if: "! which dlv"
        cmd: go install -v github.com/go-delve/delve/cmd/dlv@latest
      - if: "! which gopls"
        cmd: go install -v golang.org/x/tools/gopls@latest
      - if: "! which tfplugindocs"
        cmd: go install -v github.com/hashicorp/terraform-plugin-docs/cmd/tfplugindocs@latest
      - if: "! which golangci-lint"
        cmd: go install -v github.com/golangci/golangci-lint/v2/cmd/golangci-lint@latest

  docs:generate:
    desc: Executes tfplugindocs to generate our ./docs folder
    cmds:
      - if: "! which tfplugindocs"
        cmd: go install -v github.com/hashicorp/terraform-plugin-docs/cmd/tfplugindocs@latest
      - tfplugindocs generate
      - task: fmt

  lint:
    desc: Lints our code to ensure it remains of a high quality.
    cmds:
      - dprint check
      - deno lint
      - deno publish --dry-run --allow-dirty
      - if: "! which golangci-lint"
        cmd: go install -v github.com/golangci/golangci-lint/v2/cmd/golangci-lint@latest
      - golangci-lint run

  fmt:
    desc: Formats our code to ensure it looks consistent.
    cmds:
      - dprint fmt

  build:
    desc: Builds the terraform provider executables for local use with the example stack
    cmds:
      - mkdir -p ./bin
      - goreleaser build --clean --snapshot --single-target -o ./bin/terraform-provider-denobridge{{if eq OS "windows"}}.exe{{end}}

  test:
    desc: Runs the test suite (including tf acceptance tests)
    env:
      TF_ACC: 1
      TF_LOG: DEBUG
    cmds:
      - go test -count=1 -v ./internal/... {{.CLI_ARGS}}

  config:generate:
    desc: Generates the Terraform/OpenTofu CLI config file with absolute paths
    vars:
      TF_CLI_CONFIG_FILE: "{{.ROOT_DIR}}/.tofurc"
      TF_BIN_DIR: "{{.ROOT_DIR}}/bin"
    env:
      TF_CLI_CONFIG_FILE: "{{.TF_CLI_CONFIG_FILE | fromSlash}}"
      TF_BIN_DIR: "{{.TF_BIN_DIR | fromSlash}}"
    cmds:
      - |
          echo 'Deno.writeTextFileSync(Deno.env.get("TF_CLI_CONFIG_FILE"), `
            provider_installation {

              dev_overrides {
                "registry.terraform.io/brad-jones/denobridge" = "${Deno.env.get("TF_BIN_DIR").replaceAll("\\", "\\\\")}"
              }

              direct {}
            }
          `);' | deno run -qA -

  run:tf:
    desc: Run any terraform command against the example stack.
    summary: |
      This is useful for exploratory testing and development.

      Eg: task run:terraform -- apply
    deps:
      - build
      - config:generate
    env:
      TF_LOG: WARN
      TF_CLI_CONFIG_FILE: "{{.ROOT_DIR}}/.tofurc"
    cmds:
      - cd ./example && terraform {{.CLI_ARGS}}

  run:tofu:
    desc: Run any tofu command against the example stack.
    summary: |
      This is useful for exploratory testing and development.

      Eg: task run:tofu -- apply
    deps:
      - build
      - config:generate
    env:
      TF_LOG: WARN
      TF_CLI_CONFIG_FILE: "{{.ROOT_DIR}}/.tofurc"
    cmds:
      - cd ./example && tofu {{.CLI_ARGS}}

  run:clean:
    desc: Deletes any state associated with the example stack
    cmds:
      - |
          echo '
          function remove(path: string) {
            try {
              Deno.removeSync(path);
            } catch (error) {
              if (!(error instanceof Deno.errors.NotFound)) {
                throw error;
              }
            }
          }
          remove("./example/terraform.tfstate");
          remove("./example/terraform.tfstate.backup");
          remove("./example/bjc.mx");
          ' | deno run -qA -

  cog:
    desc: Executes 'cog bump' which orchestrates the release process.
    deps:
      - init
    preconditions:
      - '[ "$CI" = "true" ]'
    cmds:
      - deno run -qA ./scripts/try-cog-bump.ts

  package:
    desc: This is triggered by cog as a pre_bump_hook to generate all the final publishable artifacts
    requires:
      vars:
        - VERSION
    cmds:
      - >-
          echo '
            const config = JSON.parse(Deno.readTextFileSync("deno.json"));
            config.version = "{{.VERSION}}";
            Deno.writeTextFileSync("deno.json", JSON.stringify(config, null, 2));
          ' | deno run -A -
      - >-
          echo '
            let src = Deno.readTextFileSync("lib/mod.ts");
            src = src.replace(/DENOBRIDGE_VERSION = ".*?"/, `DENOBRIDGE_VERSION = "{{.VERSION}}"`);
            Deno.writeTextFileSync("lib/mod.ts", src);
          ' | deno run -A -

  publish:
    desc: This is triggered by cog as a post_bump_hook to publish all the final publishable artifacts
    requires:
      vars:
        - VERSION
    cmds:
      - deno publish
      - git push && git push --tags
      - goreleaser release --release-notes <(deno run -qA ./scripts/cog-extract-changelog.ts < CHANGELOG.md)
