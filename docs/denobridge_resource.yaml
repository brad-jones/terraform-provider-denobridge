openapi: 3.0.3
info:
  title: DenoBridge Resource API
  version: 1.0.0
  description: |
    HTTP API contract for Terraform denobridge_resource implementations.

    This specification defines the endpoints that a Deno TypeScript script must implement
    to provide full CRUD lifecycle support for a Terraform managed resource.

    The provider will start your Deno script as an HTTP server and make requests to
    these endpoints to manage the resource lifecycle.

servers:
  - url: http://localhost:{port}
    description: Local Deno HTTP server (port assigned dynamically)
    variables:
      port:
        default: "0"
        description: Port dynamically assigned by the provider

paths:
  /health:
    get:
      summary: Health check endpoint
      description: |
        The provider polls this endpoint until it receives a successful response
        before attempting to call any other lifecycle endpoints.
      responses:
        "204":
          description: Server is ready to accept requests

  /create:
    post:
      summary: Create a new resource instance
      description: |
        Creates a new instance of the resource using the provided props.
        Must return a unique ID that identifies this resource instance.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - props
              properties:
                props:
                  type: object
                  description: Input properties containing all required information to create the resource
                  additionalProperties: true
            example:
              props:
                path: "/tmp/example.txt"
                content: "Hello, World!"
      responses:
        "200":
          description: Resource created successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - id
                properties:
                  id:
                    type: string
                    description: Unique identifier for the created resource
                  state:
                    type: object
                    description: Additional computed state values only known after creation
                    additionalProperties: true
              example:
                id: "/tmp/example.txt"
                state:
                  mtime: 1705324800000
        "4XX":
          description: Client error during resource creation
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "5XX":
          description: Server error during resource creation
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /read:
    post:
      summary: Read the current state of an existing resource
      description: |
        Refreshes the current state of a resource. Should return updated props
        and state that may have changed since creation or last update.

        If the resource no longer exists, return `{"exists": false}` to signal
        Terraform to remove it from state (triggering re-creation on next plan).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - id
              properties:
                id:
                  type: string
                  description: Unique identifier of the resource to read
                props:
                  type: object
                  description: |
                    Current properties of the resource from Terraform state.
                    As much as possible you should only rely on the id to be able
                    to lookup the current props & state.

                    But in some cases you may need more than the id to uniquely identify a resource,
                    in which case you can use the previously saved props but keep in mind these may
                    not always be available.

                    You should highlight these additional props that are required for identification in your resource docs.
                    This is especially important when importing existing resources.
                  additionalProperties: true
                  nullable: true
            example:
              id: "/tmp/example.txt"
      responses:
        "200":
          description: Resource state retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  props:
                    type: object
                    description: Refreshed properties of the resource
                    additionalProperties: true
                  state:
                    type: object
                    description: Refreshed computed state values
                    additionalProperties: true
                  exists:
                    type: boolean
                    description: Set to false if the resource no longer exists
              example:
                props:
                  path: "/tmp/example.txt"
                  content: "Hello, World!"
                state:
                  mtime: 1705324800000
        "4XX":
          description: Client error during resource read
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "5XX":
          description: Server error during resource read
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /update:
    post:
      summary: Update an existing resource
      description: |
        Updates a resource in place with new property values.

        If the update cannot be performed in place (e.g., would change the ID),
        return a 422 error. Better yet, implement /modify-plan to signal
        Terraform to perform a replacement (create then delete) instead.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - id
                - currentProps
                - currentState
                - nextProps
              properties:
                id:
                  type: string
                  description: Unique identifier of the resource to update
                currentProps:
                  type: object
                  description: Current properties from Terraform state (post-refresh)
                  additionalProperties: true
                currentState:
                  type: object
                  description: Current computed state from Terraform state (post-refresh)
                  additionalProperties: true
                nextProps:
                  type: object
                  description: Desired properties to update to
                  additionalProperties: true
            example:
              id: "/tmp/example.txt"
              currentProps:
                path: "/tmp/example.txt"
                content: "Hello, World!"
              currentState:
                mtime: 1705324800000
              nextProps:
                path: "/tmp/example.txt"
                content: "Updated content"
      responses:
        "200":
          description: Resource updated successfully with new state
          content:
            application/json:
              schema:
                type: object
                properties:
                  state:
                    type: object
                    description: Updated computed state values
                    additionalProperties: true
              example:
                state:
                  mtime: 1705325000000
        "204":
          description: Resource updated successfully with no state changes
        "422":
          description: Update cannot be performed in place, requires replacement
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error: "Cannot change file path - requires resource replacement"
        "4XX":
          description: Client error during resource update
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "5XX":
          description: Server error during resource update
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /delete:
    post:
      summary: Delete an existing resource
      description: Deletes the resource and cleans up any associated infrastructure
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - id
                - props
                - state
              properties:
                id:
                  type: string
                  description: Unique identifier of the resource to delete
                props:
                  type: object
                  description: Current properties from Terraform state
                  additionalProperties: true
                state:
                  type: object
                  description: Current computed state from Terraform state
                  additionalProperties: true
            example:
              id: "/tmp/example.txt"
              props:
                path: "/tmp/example.txt"
                content: "Hello, World!"
              state:
                mtime: 1705324800000
      responses:
        "204":
          description: Resource deleted successfully
        "4XX":
          description: Client error during resource deletion
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "5XX":
          description: Server error during resource deletion
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /modify-plan:
    post:
      summary: Modify the Terraform plan (optional)
      description: |
        Optional endpoint that allows custom plan modifications.

        Common use cases:
        - Signal that a resource requires replacement instead of in-place update
        - Provide default values for unset properties
        - Add validation warnings or errors
        - Add diagnostics for resource destroy operations

        If this endpoint is not implemented (returns 404), the provider continues
        without modifications. Return 204 to indicate no changes are needed.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - id
                - planType
              properties:
                id:
                  type: string
                  description: Resource ID (empty string for create operations)
                planType:
                  type: string
                  enum: [create, update, delete]
                  description: Type of operation being planned
                nextProps:
                  type: object
                  description: Desired properties (provided for create and update)
                  additionalProperties: true
                currentProps:
                  type: object
                  description: Current properties (provided for update and delete)
                  additionalProperties: true
                currentState:
                  type: object
                  description: Current computed state (provided for update and delete)
                  additionalProperties: true
            examples:
              create:
                summary: Create plan
                value:
                  id: ""
                  planType: "create"
                  nextProps:
                    path: "/tmp/new.txt"
                    content: "New file"
              update:
                summary: Update plan
                value:
                  id: "/tmp/example.txt"
                  planType: "update"
                  currentProps:
                    path: "/tmp/example.txt"
                    content: "Old content"
                  currentState:
                    mtime: 1705324800000
                  nextProps:
                    path: "/tmp/renamed.txt"
                    content: "New content"
              delete:
                summary: Delete plan
                value:
                  id: "/tmp/example.txt"
                  planType: "delete"
                  currentProps:
                    path: "/tmp/example.txt"
                    content: "Content"
                  currentState:
                    mtime: 1705324800000
      responses:
        "200":
          description: Plan modifications returned
          content:
            application/json:
              schema:
                type: object
                properties:
                  modifiedProps:
                    type: object
                    description: Modified property values to use in the plan
                    additionalProperties: true
                  requiresReplacement:
                    type: boolean
                    description: If true, Terraform will replace (create then delete) instead of update
                  diagnostics:
                    type: array
                    description: Additional warnings or errors to display
                    items:
                      type: object
                      required:
                        - severity
                        - summary
                        - detail
                      properties:
                        severity:
                          type: string
                          enum: [error, warning]
                        summary:
                          type: string
                          description: Short diagnostic message
                        detail:
                          type: string
                          description: Detailed diagnostic message
                        propName:
                          type: string
                          description: Specific property name this diagnostic relates to
              examples:
                requiresReplacement:
                  summary: Signal replacement needed
                  value:
                    requiresReplacement: true
                modifiedProps:
                  summary: Provide default values
                  value:
                    modifiedProps:
                      content: "Default content"
                diagnostic:
                  summary: Add warning for destroy
                  value:
                    diagnostics:
                      - severity: "warning"
                        summary: "Resource Destruction Considerations"
                        detail: "Applying this resource destruction will only remove the resource from the Terraform state."
        "204":
          description: No plan modifications needed
        "404":
          description: Endpoint not implemented (provider will continue without modifications)

components:
  schemas:
    Error:
      type: object
      properties:
        error:
          type: string
          description: Error message describing what went wrong
